<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Item List with Bulk Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      background-image: url('https://static.vecteezy.com/system/resources/previews/030/182/067/large_2x/ice-cream-in-cones-on-a-dark-background-ai-generated-free-photo.jpg');
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center center;
      min-height: 100vh;
      color: white;
    }

    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .spinner-border {
      width: 3rem;
      height: 3rem;
    }

    .table-bordered, .table-bordered th, .table-bordered td {
      border: 1px solid white !important;
    }

    .table-striped tbody tr:nth-of-type(odd) {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .table-striped tbody tr:nth-of-type(even) {
      background-color: rgba(255, 255, 255, 0.05);
    }

    thead.table-dark {
      background-color: rgba(0, 0, 0, 0.8);
    }

    td, th {
      color: white;
    }

    input[type="number"] {
      width: 80px;
    }

    input[type="text"]::placeholder {
      color: #ccc;
    }

    #searchInput {
      max-width: 300px;
      margin: 0 auto 20px;
      display: block;
    }

    .btn-save {
      display: block;
      margin: 20px auto;
    }

    h2 {
      text-shadow: 1px 1px 2px black;
    }
  </style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div class="spinner-border text-light" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="container mt-5">
  <h2 class="mb-4 text-center">Item List</h2>

  <!-- Search box -->
  <input type="text" id="searchInput" class="form-control" placeholder="Search items...">

  <table class="table table-bordered table-striped" id="itemTable">
    <thead class="table-dark">
      <tr>
        <th>Select</th>
        <th>Material Name</th>
        <th>Description</th>
        <th>UOM</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody>
      <!-- Data will be inserted here -->
    </tbody>
  </table>

<!-- Save Button -->
<button id="saveOrders" class="btn btn-primary btn-save">Save Selected Orders</button>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const loader = document.getElementById("loader");
    const searchInput = document.getElementById("searchInput");
    const itemTableBody = document.querySelector("#itemTable tbody");
    let materials = [];

    // Fetch data from API
    fetch("https://stocknest-w3r4.onrender.com/api/materials")
      .then(response => {
        if (!response.ok) throw new Error("Failed to fetch data");
        return response.json();
      })
      .then(data => {
        materials = data;
        renderTable(materials);
      })
      .catch(error => {
        console.error("Error fetching data:", error);
        itemTableBody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Failed to load data</td></tr>`;
      })
      .finally(() => {
        loader.style.display = "none";
      });

    // Render the item table with checkboxes and quantity input
    function renderTable(items) {
      itemTableBody.innerHTML = "";
      items.forEach((item, index) => {
        const row = `
          <tr>
            <td class="text-center">
              <input type="checkbox" class="form-check-input" data-index="${index}">
            </td>
            <td>${item.MaterialName}</td>
            <td>${item.Description}</td>
            <td>${item.UOM}</td>
            <td>
              <input type="number" class="form-control quantity-input" data-index="${index}" min="1" disabled />
            </td>
          </tr>
        `;
        itemTableBody.insertAdjacentHTML("beforeend", row);
      });

      // Enable/disable quantity input based on checkbox
      document.querySelectorAll("input[type='checkbox']").forEach(checkbox => {
        checkbox.addEventListener("change", function () {
          const index = this.getAttribute("data-index");
          const qtyInput = document.querySelector(`.quantity-input[data-index="${index}"]`);
          qtyInput.disabled = !this.checked;
          if (!this.checked) qtyInput.value = "";
        });
      });
    }

    // Search filter
    searchInput.addEventListener("input", function () {
      const searchTerm = this.value.toLowerCase();
      const filtered = materials.filter(item =>
        item.MaterialName.toLowerCase().includes(searchTerm) ||
        item.Description.toLowerCase().includes(searchTerm)
      );
      renderTable(filtered);
    });

    // Handle Save Orders button
    document.getElementById("saveOrders").addEventListener("click", function () {
      const selectedOrders = [];

      document.querySelectorAll("input[type='checkbox']:checked").forEach(checkbox => {
        const index = checkbox.getAttribute("data-index");
        const material = materials[index];
        const quantity = document.querySelector(`.quantity-input[data-index="${index}"]`).value;

        if (quantity && parseInt(quantity) > 0) {
          selectedOrders.push({
            item: material.MaterialName,
            uom: material.UOM,
            quantity: parseInt(quantity)
          });
        }
      });

      if (selectedOrders.length === 0) {
        alert("Please select at least one item and enter quantity.");
        return;
      }

      // Post the data (replace with real backend URL)
      fetch("https://your-api-endpoint.com/save-orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ orders: selectedOrders })
      })
        .then(response => {
          if (!response.ok) throw new Error("Failed to save orders");
          return response.json();
        })
        .then(result => {
          alert("Orders saved successfully!");
          // Reset selections
          document.querySelectorAll("input[type='checkbox']").forEach(cb => cb.checked = false);
          document.querySelectorAll(".quantity-input").forEach(input => {
            input.disabled = true;
            input.value = "";
          });
        })
        .catch(error => {
          console.error("Save error:", error);
          alert("Error saving orders. Please try again.");
        });
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
